<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç—É–¥–µ–Ω—á–µ—Å–∫–∞—è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .library-card { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
        .nav-tabs { margin-bottom: 20px; }
        .stat-card { background: #f1f8ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center my-4">üìö –°—Ç—É–¥–µ–Ω—á–µ—Å–∫–∞—è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h1>
        
        <div class="library-card">
            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#books">–ö–Ω–∏–≥–∏</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#students">–°—Ç—É–¥–µ–Ω—Ç—ã</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#loans">–í—ã–¥–∞—á–∏</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
                </li>
            </ul>

            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
            <div class="tab-content">
                <!-- –í–∫–ª–∞–¥–∫–∞ –∫–Ω–∏–≥ -->
                <div class="tab-pane fade show active" id="books">
                    <button class="btn btn-primary mb-3" onclick="showBookModal()">–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É</button>
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th>–ê–≤—Ç–æ—Ä</th>
                                <th>–ì–æ–¥</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="booksTable"></tbody>
                    </table>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ -->
                <div class="tab-pane fade" id="students">
                    <button class="btn btn-primary mb-3" onclick="showStudentModal()">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞</button>
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>–§–ò–û</th>
                                <th>–ì—Ä—É–ø–ø–∞</th>
                                <th>–ö–æ–Ω—Ç–∞–∫—Ç</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTable"></tbody>
                    </table>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ –≤—ã–¥–∞—á–∏ -->
                <div class="tab-pane fade" id="loans">
                    <button class="btn btn-primary mb-3" onclick="showLoanModal()">–û—Ñ–æ—Ä–º–∏—Ç—å –≤—ã–¥–∞—á—É</button>
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>–°—Ç—É–¥–µ–Ω—Ç</th>
                                <th>–ö–Ω–∏–≥–∞</th>
                                <th>–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</th>
                                <th>–°—Ä–æ–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="loansTable"></tbody>
                    </table>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
                <div class="tab-pane fade" id="stats">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="stat-card">
                                <h4>üìä –ö–Ω–∏–≥ –Ω–∞ —Ä—É–∫–∞—Ö</h4>
                                <canvas id="loansChart" height="200"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stat-card">
                                <h4>‚ö† –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏</h4>
                                <canvas id="overdueChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card mt-3">
                        <h4>üë• –ê–∫—Ç–∏–≤–Ω—ã–µ —á–∏—Ç–∞—Ç–µ–ª–∏</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>–°—Ç—É–¥–µ–Ω—Ç</th>
                                    <th>–ö–Ω–∏–≥ –Ω–∞ —Ä—É–∫–∞—Ö</th>
                                    <th>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</th>
                                </tr>
                            </thead>
                            <tbody id="readersStats"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div class="modal fade" id="bookModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookModalTitle">–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bookForm">
                        <input type="hidden" id="bookId">
                        <div class="mb-3">
                            <label for="bookTitle" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                            <input type="text" class="form-control" id="bookTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="bookAuthor" class="form-label">–ê–≤—Ç–æ—Ä</label>
                            <input type="text" class="form-control" id="bookAuthor" required>
                        </div>
                        <div class="mb-3">
                            <label for="bookYear" class="form-label">–ì–æ–¥ –∏–∑–¥–∞–Ω–∏—è</label>
                            <input type="number" class="form-control" id="bookYear">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="saveBook()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="studentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="studentModalTitle">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="studentForm">
                        <input type="hidden" id="studentId">
                        <div class="mb-3">
                            <label for="studentName" class="form-label">–§–ò–û</label>
                            <input type="text" class="form-control" id="studentName" required>
                        </div>
                        <div class="mb-3">
                            <label for="studentGroup" class="form-label">–ì—Ä—É–ø–ø–∞</label>
                            <input type="text" class="form-control" id="studentGroup" required>
                        </div>
                        <div class="mb-3">
                            <label for="studentContact" class="form-label">–ö–æ–Ω—Ç–∞–∫—Ç</label>
                            <input type="text" class="form-control" id="studentContact">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="saveStudent()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="loanModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–û—Ñ–æ—Ä–º–∏—Ç—å –≤—ã–¥–∞—á—É –∫–Ω–∏–≥–∏</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loanForm">
                        <div class="mb-3">
                            <label for="loanStudent" class="form-label">–°—Ç—É–¥–µ–Ω—Ç</label>
                            <select class="form-select" id="loanStudent" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="loanBook" class="form-label">–ö–Ω–∏–≥–∞</label>
                            <select class="form-select" id="loanBook" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–Ω–∏–≥—É</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="loanDueDate" class="form-label">–°—Ä–æ–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞</label>
                            <input type="date" class="form-control" id="loanDueDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="saveLoan()">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ–º localStorage –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏)
        let students = JSON.parse(localStorage.getItem('libraryStudents')) || [
            { id: 1, name: "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á", group: "–ò–¢-101", contact: "ivanov@example.com" },
            { id: 2, name: "–ü–µ—Ç—Ä–æ–≤–∞ –ê–Ω–Ω–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞", group: "–ò–¢-102", contact: "petrova@example.com" }
        ];

        let books = JSON.parse(localStorage.getItem('libraryBooks')) || [
            { id: 1, title: "–í–≤–µ–¥–µ–Ω–∏–µ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ", author: "–°–º–∏—Ç –î–∂–æ–Ω", year: 2020, available: true },
            { id: 2, title: "–û—Å–Ω–æ–≤—ã –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö", author: "–ö—É–∑–Ω–µ—Ü–æ–≤ –ê.–ê.", year: 2019, available: false }
        ];

        let loans = JSON.parse(localStorage.getItem('libraryLoans')) || [
            { 
                id: 1, 
                studentId: 2, 
                bookId: 2, 
                issueDate: new Date().toISOString().split('T')[0], 
                dueDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                returned: false 
            }
        ];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            renderBooks();
            renderStudents();
            renderLoans();
            renderStats();
        });

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
        function saveData() {
            localStorage.setItem('libraryStudents', JSON.stringify(students));
            localStorage.setItem('libraryBooks', JSON.stringify(books));
            localStorage.setItem('libraryLoans', JSON.stringify(loans));
        }

        // ===== –ö–ù–ò–ì–ò =====
        function renderBooks() {
            const table = document.getElementById('booksTable');
            table.innerHTML = books.map(book => {
                const isAvailable = book.available ? '–î–æ—Å—Ç—É–ø–Ω–∞' : '–ù–∞ —Ä—É–∫–∞—Ö';
                const badgeClass = book.available ? 'bg-success' : 'bg-warning';
                
                return `
                    <tr>
                        <td>${book.id}</td>
                        <td>${book.title}</td>
                        <td>${book.author}</td>
                        <td>${book.year || '-'}</td>
                        <td><span class="badge ${badgeClass}">${isAvailable}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editBook(${book.id})">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteBook(${book.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showBookModal(book = null) {
            const modal = new bootstrap.Modal(document.getElementById('bookModal'));
            const form = document.getElementById('bookForm');
            
            form.reset();
            document.getElementById('bookId').value = '';
            
            if (book) {
                document.getElementById('bookModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É';
                document.getElementById('bookId').value = book.id;
                document.getElementById('bookTitle').value = book.title;
                document.getElementById('bookAuthor').value = book.author;
                document.getElementById('bookYear').value = book.year || '';
            } else {
                document.getElementById('bookModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É';
            }
            
            modal.show();
        }

        function saveBook() {
            const id = document.getElementById('bookId').value;
            const title = document.getElementById('bookTitle').value.trim();
            const author = document.getElementById('bookAuthor').value.trim();
            const year = document.getElementById('bookYear').value;
            
            if (!title || !author) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!');
                return;
            }
            
            if (id) {
                // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–Ω–∏–≥–∏
                const index = books.findIndex(b => b.id == id);
                if (index !== -1) {
                    books[index] = { 
                        ...books[index],
                        title, 
                        author, 
                        year: year || null
                    };
                }
            } else {
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∫–Ω–∏–≥–∏
                const newId = books.length > 0 ? Math.max(...books.map(b => b.id)) + 1 : 1;
                books.push({
                    id: newId,
                    title,
                    author,
                    year: year || null,
                    available: true
                });
            }
            
            saveData();
            renderBooks();
            bootstrap.Modal.getInstance(document.getElementById('bookModal')).hide();
        }

        function editBook(id) {
            const book = books.find(b => b.id == id);
            if (book) showBookModal(book);
        }

        function deleteBook(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–Ω–∏–≥—É? –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –≤—ã–¥–∞—á–∏ —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) {
                books = books.filter(b => b.id != id);
                loans = loans.filter(l => l.bookId != id);
                saveData();
                renderBooks();
                renderLoans();
                renderStats();
            }
        }

        // ===== –°–¢–£–î–ï–ù–¢–´ =====
        function renderStudents() {
            const table = document.getElementById('studentsTable');
            table.innerHTML = students.map(student => `
                <tr>
                    <td>${student.id}</td>
                    <td>${student.name}</td>
                    <td>${student.group}</td>
                    <td>${student.contact || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editStudent(${student.id})">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent(${student.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function showStudentModal(student = null) {
            const modal = new bootstrap.Modal(document.getElementById('studentModal'));
            const form = document.getElementById('studentForm');
            
            form.reset();
            document.getElementById('studentId').value = '';
            
            if (student) {
                document.getElementById('studentModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞';
                document.getElementById('studentId').value = student.id;
                document.getElementById('studentName').value = student.name;
                document.getElementById('studentGroup').value = student.group;
                document.getElementById('studentContact').value = student.contact || '';
            } else {
                document.getElementById('studentModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞';
            }
            
            modal.show();
        }

        function saveStudent() {
            const id = document.getElementById('studentId').value;
            const name = document.getElementById('studentName').value.trim();
            const group = document.getElementById('studentGroup').value.trim();
            const contact = document.getElementById('studentContact').value.trim();
            
            if (!name || !group) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!');
                return;
            }
            
            if (id) {
                // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
                const index = students.findIndex(s => s.id == id);
                if (index !== -1) {
                    students[index] = { 
                        ...students[index],
                        name, 
                        group, 
                        contact: contact || null
                    };
                }
            } else {
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
                const newId = students.length > 0 ? Math.max(...students.map(s => s.id)) + 1 : 1;
                students.push({
                    id: newId,
                    name,
                    group,
                    contact: contact || null
                });
            }
            
            saveData();
            renderStudents();
            bootstrap.Modal.getInstance(document.getElementById('studentModal')).hide();
        }

        function editStudent(id) {
            const student = students.find(s => s.id == id);
            if (student) showStudentModal(student);
        }

        function deleteStudent(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞? –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –≤—ã–¥–∞—á–∏ —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) {
                students = students.filter(s => s.id != id);
                loans = loans.filter(l => l.studentId != id);
                saveData();
                renderStudents();
                renderLoans();
                renderStats();
            }
        }

        // ===== –í–´–î–ê–ß–ò –ö–ù–ò–ì =====
        function renderLoans() {
            const table = document.getElementById('loansTable');
            table.innerHTML = loans.map(loan => {
                const student = students.find(s => s.id == loan.studentId);
                const book = books.find(b => b.id == loan.bookId);
                const isOverdue = !loan.returned && new Date(loan.dueDate) < new Date();
                const status = loan.returned 
                    ? '<span class="badge bg-secondary">–í–æ–∑–≤—Ä–∞—â–µ–Ω–∞</span>'
                    : isOverdue 
                        ? '<span class="badge bg-danger">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞</span>'
                        : '<span class="badge bg-primary">–ù–∞ —Ä—É–∫–∞—Ö</span>';
                
                return `
                    <tr>
                        <td>${loan.id}</td>
                        <td>${student?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                        <td>${book?.title || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                        <td>${loan.issueDate}</td>
                        <td>${loan.dueDate}</td>
                        <td>${status}</td>
                        <td>
                            ${!loan.returned ? `<button class="btn btn-sm btn-success" onclick="returnBook(${loan.id})">‚úÖ –í–µ—Ä–Ω—É—Ç—å</button>` : ''}
                            <button class="btn btn-sm btn-danger" onclick="deleteLoan(${loan.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showLoanModal() {
            const modal = new bootstrap.Modal(document.getElementById('loanModal'));
            const studentSelect = document.getElementById('loanStudent');
            const bookSelect = document.getElementById('loanBook');
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            studentSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞</option>';
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} (${student.group})`;
                studentSelect.appendChild(option);
            });
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–Ω–∏–≥
            bookSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–Ω–∏–≥—É</option>';
            books.filter(book => book.available).forEach(book => {
                const option = document.createElement('option');
                option.value = book.id;
                option.textContent = `${book.title} (${book.author})`;
                bookSelect.appendChild(option);
            });
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –≤–æ–∑–≤—Ä–∞—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é +14 –¥–Ω–µ–π)
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 14);
            document.getElementById('loanDueDate').value = dueDate.toISOString().split('T')[0];
            
            modal.show();
        }

        function saveLoan() {
            const studentId = parseInt(document.getElementById('loanStudent').value);
            const bookId = parseInt(document.getElementById('loanBook').value);
            const dueDate = document.getElementById('loanDueDate').value;
            
            if (!studentId || !bookId || !dueDate) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            const newId = loans.length > 0 ? Math.max(...loans.map(l => l.id)) + 1 : 1;
            
            loans.push({
                id: newId,
                studentId,
                bookId,
                issueDate: today,
                dueDate,
                returned: false
            });
            
            // –ü–æ–º–µ—á–∞–µ–º –∫–Ω–∏–≥—É –∫–∞–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—É—é
            const bookIndex = books.findIndex(b => b.id === bookId);
            if (bookIndex !== -1) {
                books[bookIndex].available = false;
            }
            
            saveData();
            renderBooks();
            renderLoans();
            renderStats();
            bootstrap.Modal.getInstance(document.getElementById('loanModal')).hide();
        }

        function returnBook(loanId) {
            const loanIndex = loans.findIndex(l => l.id === loanId);
            if (loanIndex !== -1) {
                loans[loanIndex].returned = true;
                
                // –ü–æ–º–µ—á–∞–µ–º –∫–Ω–∏–≥—É –∫–∞–∫ –¥–æ—Å—Ç—É–ø–Ω—É—é
                const bookId = loans[loanIndex].bookId;
                const bookIndex = books.findIndex(b => b.id === bookId);
                if (bookIndex !== -1) {
                    books[bookIndex].available = true;
                }
                
                saveData();
                renderBooks();
                renderLoans();
                renderStats();
            }
        }

        function deleteLoan(loanId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å –æ –≤—ã–¥–∞—á–µ?')) {
                const loanIndex = loans.findIndex(l => l.id === loanId);
                if (loanIndex !== -1 && !loans[loanIndex].returned) {
                    // –ü–æ–º–µ—á–∞–µ–º –∫–Ω–∏–≥—É –∫–∞–∫ –¥–æ—Å—Ç—É–ø–Ω—É—é, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –±—ã–ª–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞
                    const bookId = loans[loanIndex].bookId;
                    const bookIndex = books.findIndex(b => b.id === bookId);
                    if (bookIndex !== -1) {
                        books[bookIndex].available = true;
                    }
                }
                
                loans = loans.filter(l => l.id !== loanId);
                saveData();
                renderBooks();
                renderLoans();
                renderStats();
            }
        }

        // ===== –°–¢–ê–¢–ò–°–¢–ò–ö–ê =====
        function renderStats() {
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–Ω–∏–≥–∞–º
            const activeLoans = loans.filter(l => !l.returned).length;
            const overdueLoans = loans.filter(l => !l.returned && new Date(l.dueDate) < new Date()).length;
            
            renderChart('loansChart', '–ö–Ω–∏–≥ –Ω–∞ —Ä—É–∫–∞—Ö', activeLoans);
            renderChart('overdueChart', '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ', overdueLoans);
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç—É–¥–µ–Ω—Ç–∞–º
            const readersStats = document.getElementById('readersStats');
            readersStats.innerHTML = students.map(student => {
                const studentLoans = loans.filter(l => l.studentId === student.id && !l.returned);
                const studentOverdue = studentLoans.filter(l => new Date(l.dueDate) < new Date()).length;
                
                return `
                    <tr>
                        <td>${student.name}</td>
                        <td>${studentLoans.length}</td>
                        <td>${studentOverdue}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderChart(canvasId, label, value) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            if (window[`${canvasId}Chart`]) {
                window[`${canvasId}Chart`].destroy();
            }
            
            window[`${canvasId}Chart`] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [label, '–û—Å—Ç–∞–ª—å–Ω–æ–µ'],
                    datasets: [{
                        data: [value, Math.max(1, 10 - value)],
                        backgroundColor: [
                            label === '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ' ? '#dc3545' : '#0d6efd',
                            '#e9ecef'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>